<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="./elasticjs.html">
<link rel="import" href="./lodash.html">

<!--
Element which fetches and provides a select input for an ElasticSearch index

Example:
    <elastic-client
        config='{"host": "http://localhost:9200"}'
        client={{esClient}}
        cluster-status={{esStatus}}
    >
    </elastic-client>

    <elastic-type-selector
        client=[[esClient]]
        index="ads"
        selected-type={{selectedType}}
        available-types={{availableTypes}}
    ></elastic-type-selector>

@demo demo/index.html
-->
<dom-module id="elastic-type-selector">
    <template>
        <paper-dropdown-menu label="Type" value="{{selectedType}}">
            <paper-menu class="dropdown-content" selected="0">
                <template is="dom-repeat" items="{{availableTypes}}" as="availableType">
                    <paper-item>{{availableType}}</paper-item>
                </template>
            </paper-menu>
        </paper-dropdown-menu>
    </template>

    <script>
        (function() {
            'use strict';
            Polymer({
                is: 'elastic-type-selector',

                properties: {
                    /**
                     * The currently selected type
                     */
                    selectedType: {
                        type: String,
                        notify: true,
                        value: 'ALL'
                    },

                    /**
                     * array of strings that should be bound to elastic-client-search 
                     * type attribute
                     */
                    elasticTypes: {
                        type: Array,
                        notify: true,
                        value: []
                    },

                    /**
                     * The available types.  This is set automatically with an elastic
                     * query if both index and client are defined.
                     */
                    availableTypes: {
                        type: Array,
                        notify: true
                    },

                    /**
                     * The elasticsearch index for which types should be fetched
                     */
                    index: {
                        type: String
                    },

                    /**
                     * The elasticsearch client to use to fetch the types.  Don't
                     * supply this object if you are initializing availableTypes
                     * with an array.
                     */
                    client: {
                        type: Object
                    }
                },

                observers: [
                    'fetchAvailableTypes(client, index)',
                    'setElasticTypes(selectedType)'
                ],

                /**
                 * Query elasticsearch for the available types using
                 * the supplied elasticsearch client
                */
                fetchAvailableTypes: function(client, index) {
                    var self = this;

                    client.indices.getMapping({
                        index: index
                    })
                    .then(function(mapping) {
                        var types = ['ALL'];
                        _.each(mapping[index].mappings, function(typeMapping, type) {
                            if(type !== '_default_') {
                                types.push(type);
                            }
                        });
                        self.availableTypes = types;
                        return;
                    });
                },

                /**
                 * if array contains string 'ALL', then return empty array.
                 * in elastic, an empty array will by default query over all types
                 */
                setElasticTypes: function(selectedType) {
                    this.elasticTypes = (selectedType === 'ALL') ? [] : [selectedType];
                }
            });
        })();
    </script>
</dom-module>
